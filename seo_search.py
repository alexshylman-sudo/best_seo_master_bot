import logging
from duckduckgo_search import DDGS

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥—É–ª—è, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –æ—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
logger = logging.getLogger(__name__)

def search_relevant_links(query: str, max_results: int = 5) -> list:
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ –≤ DuckDuckGo –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.
    
    Args:
        query (str): –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å (–¢–µ–º–∞ + –∫–ª—é—á–∏).
        max_results (int): –°–∫–æ–ª—å–∫–æ —Å—Å—ã–ª–æ–∫ –∏—Å–∫–∞—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5).

    Returns:
        list: –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π [{'title': ..., 'href': ..., 'snippet': ...}]
    """
    logger.info(f"üöÄ –ó–∞–ø—É—Å–∫ –º–æ–¥—É–ª—è –ø–æ–∏—Å–∫–∞. –ó–∞–ø—Ä–æ—Å: {query}")
    results = []

    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–∏—Å–∫. timelimit='y' –æ–∑–Ω–∞—á–∞–µ—Ç –∏—Å–∫–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥ (–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ)
        with DDGS() as ddgs:
            ddg_gen = ddgs.text(
                keywords=query,
                region='wt-wt',      # –ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É (–±–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)
                safesearch='moderate', # –£–º–µ—Ä–µ–Ω–Ω—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–æ–∏—Å–∫
                timelimit='y',       # –¢–æ–ª—å–∫–æ —Å–≤–µ–∂–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
                max_results=max_results
            )
            
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤ —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π
            for r in ddg_gen:
                results.append({
                    'title': r.get('title', '–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞'),
                    'href': r.get('href', '#'),
                    'snippet': r.get('body', '')
                })

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ –º–æ–¥—É–ª–µ seo_search: {e}")
        # –ï—Å–ª–∏ –ø–æ–∏—Å–∫ —É–ø–∞–ª, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫, —á—Ç–æ–±—ã –±–æ—Ç –Ω–µ –∑–∞–≤–∏—Å
        return []

    return results


def format_search_results(links: list) -> str:
    """
    –ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç "—Å—ã—Ä—ã–µ" –¥–∞–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–∞ –≤ –∫—Ä–∞—Å–∏–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –¢–µ–ª–µ–≥—Ä–∞–º–∞.
    """
    if not links:
        return "üòî –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –≤–Ω–µ—à–Ω–∏—Ö —Å—Å—ã–ª–æ–∫ –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ."

    # –§–æ—Ä–º–∏—Ä—É–µ–º HTML —Å–æ–æ–±—â–µ–Ω–∏–µ
    msg = "üåê <b>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –≤–Ω–µ—à–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (TrustRank):</b>\n\n"
    
    for i, link in enumerate(links, 1):
        title = link['title'].replace("<", "&lt;").replace(">", "&gt;") # –ß–∏—Å—Ç–∏–º –æ—Ç –ª–∏—à–Ω–∏—Ö —Ç–µ–≥–æ–≤
        url = link['href']
        # domain = url.split('/')[2] if '//' in url else url # –ú–æ–∂–Ω–æ –≤—ã–≤–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ –¥–æ–º–µ–Ω
        
        msg += f"{i}. <a href='{url}'><b>{title}</b></a>\n"
        msg += f"üîó <i>{url}</i>\n\n"

    msg += "üëá <b>–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏:</b>\n"
    msg += "–ù–∞–ø–∏—à–∏—Ç–µ <b>–Ω–æ–º–µ—Ä–∞</b> —Ç–µ—Ö —Å—Å—ã–ª–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –≤ —Å—Ç–∞—Ç—å—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: <code>1, 3</code>).\n"
    msg += "–ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ <b>0</b>, —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç—Ç–æ—Ç —à–∞–≥."
    
    return msg